var MessagesView=null;!function(e){MessagesView=BaseBackboneView.extend({events:{"click .ico-refresh":"changeCaptcha"},initialize:function(){this.constructor.__super__.initialize.call(this);var t=this;this.adopted=!0,this.options.captcha.on("change",this.drawCaptcha,this),this.options.messages.on("add",this.addMessage,this);var o=e(".template-messages");o.get(0)?(this.messages=[],this.setElement(o),this.options.onload&&this.options.onload.call(t)):(this.adopted=!1,render_template("template_message_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/messages/"+this.options.noivos.get("template_html_version")+"/index",{noivos:this.options.noivos.attributes,messages:this.options.messages.toJSON(),pagina:this.options.pagina.attributes,captcha:this.options.captcha.attributes},function(e){t.messages=[],t.setElement(e),t.options.onload&&t.options.onload.call(t)}))},addMessage:function(t,o,n){var a=this;new MessageView({noivos:this.options.noivos,message:t,onload:function(){this.render(),this.adopted||0!=t.get("aprovada")&&(e(".no-message").remove(),e(".def-messages").prepend(this.$el),this.$el.addClass("start_vertical_roll_animation")),a.messages[t.get("id_template_msg_noivos")]=this;var o=I18n.t("messages.message_sent");0==t.get("aprovada")&&(o+="<br/>"+I18n.t("messages.message_waiting")),e(".def-result-message").html(o),e(".def-result-message").removeClass("error").addClass("success"),e(".def-result-message").show()}})},changeCaptcha:function(){this.options.captcha.fetch({data:{object:"message"},success:function(){}})},drawCaptcha:function(){e("input[name='captcha_key']").val(this.options.captcha.get("key")),e(".captcha img").attr("src",this.options.captcha.get("image"))},render:function(){var t=this;return t.drawCaptcha(),this.options.messages.each(function(o){var n=new MessageView({noivos:t.options.noivos,message:o});n.render(),n.adopted||e(".def-messages").prepend(n.$el),t.messages[o.get("id_template_msg_noivos")]=n}),load_css("//assets1.icasei.com.br/assets/formhelper.css"),load_js("//assets1.icasei.com.br/assets/formhelper.js",function(){e("#mensagem").formhelper({defaultField:"nome",autoRender:!1,messages:form_helper_messages,onSubmitError:function(){e(".def-result-message").addClass("error").removeClass("success"),e(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),e(".def-result-message").show(),e("html,body").animate({scrollTop:0},200)},onSubmit:function(){var o=(this.getData(),t.options.noivos.get("id_noivo")),n=e("#mensagem #nome").val(),a=e("#mensagem #email").val(),i=e("#mensagem #mensagem").val(),r=e("#mensagem #captcha").val(),s=e("#mensagem #captcha_key").val(),l=new TemplateMsgNoivo;return window.loading.jLoading("block",!0),l.save({nome:n,email:a,message:i,captcha:r,captcha_key:s,id_noivo:o},{wait:!0,success:function(o,n,a){window.loading.jLoading("block",!1),t.options.messages.add(l),e("#mensagem").formhelper("setvalue","nome",""),e("#mensagem").formhelper("setvalue","email",""),e("#mensagem").formhelper("setvalue","mensagem",""),e("#mensagem").formhelper("setvalue","captcha","")},error:function(t,o,n){window.loading.jLoading("block",!1);var a=o.responseText,i=JSON.parse(a);for(var r in i.errors){var s=i.errors[r];e("#mensagem").formhelper("flagerror",s.key,s.value)}e(".def-result-message").addClass("error").removeClass("success"),e(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),e(".def-result-message").show()}}),!1}}),e("#mensagem").formhelper("init")}),this}})}(jQuery);