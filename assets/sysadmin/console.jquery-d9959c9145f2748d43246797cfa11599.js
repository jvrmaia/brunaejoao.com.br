function Console(e,t){return this.options=jQuery.extend({},Console.CONSOLE_DEFAULTS,t||{}),this.element=e,this.ctx=this.element.getContext("2d"),this.ctx?void 0:void alert("2d context not found")}jQuery.fn.console=function(e,t){return"string"!=typeof e?(e=e||{},this.each(function(t,n){"canvas"==n.nodeName.toLowerCase()&&(n.console=new Console(n,e),n.console.init_console())})):this.each(function(n,a){"set_text"==e?a.console._set_text(t):"write"==e?a.console._write(t):"writeln"==e?a.console._writeln(t):"register_command"==e?a.console.register_command(t):"lock_input"==e&&a.console.lock_input()}),this},Console.prototype.init_console=function(){this.width=jQuery(this.element).width(),this.height=jQuery(this.element).height(),this.ctx.font="normal "+this.options.fontsize+"px "+this.options.fontname,this.fontwidth=this.ctx.measureText("M").width+1,this.fontheight=this.options.fontsize,this.cols=Math.floor(this.width/this.fontwidth)-1,this.rows=Math.floor(this.height/this.fontheight)-1,this.init_buffer(),this.blink_cursor();var e=this;jQuery(this.element).bind("keydown",function(t){return e._keydown(t)}),jQuery(this.element).bind("keypress",function(t){return e._keypress(t)}),jQuery(this.element).bind("mousewheel",function(t){return e._mouse_wheel(t)}),jQuery(this.element).bind("DOMMouseScroll",function(t){return e._mouse_wheel(t)}),setInterval(function(){e.draw_buffer()},33),this.commands=new Array,this.command_history=new Array,this.current_command=0,this.addr_format=new Array,this.register_command({command:this.options.helpcommand,description:this.options.helpcommanddesc,callback:function(e,t){for(var n=0;n<this.commands.length;n++){var a=this.commands[n];n>0&&this.writeln(""),this.write(a.command),this.write(this.options.helpspaces),this.write(a.description)}}}),this.register_command({command:this.options.clearcommand,description:this.options.clearcommanddesc,callback:function(e,t){return this.command_history=new Array,this.current_command=0,this.addr_format=new Array,this.init_buffer(),!0}})},Console.prototype._mouse_wheel=function(e){e.detail||(e.wheelDelta>0?e.detail=-1:e.detail=1);var t=e.detail*Math.ceil(this.rows/3);this.memmap_addr+=t*this.cols,this.memmap_addr<0?this.memmap_addr=0:this.memmap_addr+this.rows*this.cols>=this.buffer.length&&(this.memmap_addr=this.buffer.length-this.rows*this.cols)},Console.prototype.clear_cursor=function(){this.cursor&&(this.buffer[this.memmap_addr+this.cursor_row*this.cols+this.cursor_col]=" ",this.cursor_col=0,this.cursor_row=0,this.cursor=!1)},Console.prototype.blink_cursor=function(){var e=this;setInterval(function(){e.enable_external_input?"_"==e.buffer[e.memmap_addr+e.current_row*e.cols+e.current_col]?(e.buffer[e.memmap_addr+e.current_row*e.cols+e.current_col]=" ",e.cursor_col=-1,e.cursor_row=-1,e.cursor=!1):(e.buffer[e.memmap_addr+e.current_row*e.cols+e.current_col]="_",e.cursor_col=e.current_col,e.cursor_row=e.current_row,e.cursor=!0):e.input&&e.memmap_addr==e.original_memmap_addr&&("_"==e.buffer[e.memmap_addr+e.current_row*e.cols+e.current_col]?(e.buffer[e.memmap_addr+e.current_row*e.cols+e.current_col]=" ",e.cursor_col=-1,e.cursor_row=-1,e.cursor=!1):(e.buffer[e.memmap_addr+e.current_row*e.cols+e.current_col]="_",e.cursor_col=e.current_col,e.cursor_row=e.current_row,e.cursor=!0))},500)},Console.prototype.init_buffer=function(){this.current_row=0,this.current_col=0,this.memmap_addr=0,this.original_memmap_addr=this.memmap_addr,this.buffer=new Array;for(var e=0;e<this.rows*this.cols;e++)this.buffer[e]=" ";this.options.oninit&&this.options.oninit.call(this),this.lock_input()},Console.prototype.register_command=function(e){e.command&&e.callback&&e.description&&(this.commands.push(e),this.commands.sort(this._sort_commands))},Console.prototype._sort_commands=function(e,t){return e.command==t.command?0:e.command>t.command?1:-1},Console.prototype._keydown=function(e){if(this.input){if(this.memmap_addr=this.original_memmap_addr,this.clear_cursor(),13==e.which)return this.input=!1,this.parse_command_line(),e.preventDefault(),e.stopPropagation(),!1;if(8==e.which)return this.current_col--,this.current_col<this.command_start_col&&this.command_start_row==this.current_row?this.current_col=this.command_start_col:this.current_col<0&&(this.current_col=this.cols-1,this.current_row--),this.buffer[this.memmap_addr+this.current_row*this.cols+this.current_col]=" ",this.command.length>0&&this.command.pop(),e.preventDefault(),e.stopPropagation(),!1;if(38==e.which)return this.current_command>0&&this.set_command(this.command_history[--this.current_command]),e.preventDefault(),e.stopPropagation(),!1;if(40==e.which)return this.current_command<this.command_history.length-1?this.set_command(this.command_history[++this.current_command]):(this.set_command([""]),++this.current_command),e.preventDefault(),e.stopPropagation(),!1}else if(this.enable_external_input){if(this.clear_cursor(),13==e.which)return!this.grab_extended||e.ctrlKey?(this.command.length>0||!this.grab_required)&&(this.enable_external_input=!1,this.external_input_callback.call(this,this.command.join(""))):this.grab_extended&&(this.last_col.push(this.current_col),this.command.push("\n"),this.writeln("")),e.preventDefault(),e.stopPropagation(),!1;if(8==e.which)return this.current_col--,this.current_col<this.command_start_col&&this.command_start_row==this.current_row?this.current_col=this.command_start_col:this.current_col<0&&(this.current_col=this.last_col.pop(),this.current_row--),this.buffer[this.memmap_addr+this.current_row*this.cols+this.current_col]=" ",this.command.length>0&&this.command.pop(),e.preventDefault(),e.stopPropagation(),!1;if(67==e.which&&e.ctrlKey)return this.write("^C"),this.enable_external_input=!1,this.external_input_callback.call(this,"^C"),e.preventDefault(),e.stopPropagation(),!1}},Console.prototype.set_command=function(e){this.command=e;for(var t=this.command_start_row;t<=this.current_row;t++)for(var n=this.command_start_col;n<this.current_col;n++)this.buffer[this.memmap_addr+t*this.cols+n]=" ";this.current_row=this.command_start_row,this.current_col=this.command_start_col,this.write(this.command.join(""))},Console.prototype._keypress=function(e){if((this.input||this.enable_external_input)&&e.charCode>0){this.memmap_addr=this.original_memmap_addr,this.clear_cursor();var t=String.fromCharCode(e.charCode);this.command.push(t),this.grab_password?this.write("*"):this.write(t)}},Console.prototype._find_command=function(e){for(var t=0;t<this.commands.length;t++)if(this.commands[t].command==e)return this.commands[t];return null},Console.prototype.parse_command_line=function(){this.writeln("");var e=this.command.join(""),t=e.split(" ");if(t.length>0&&t[0].length>0){this.command_history.push(this.command);var n=this._find_command(t[0]);if(n&&n.callback){if(n.callback.call(this,t.length,t))return void(this.current_command=this.command_history.length)}else this.write(t[0]+": "+this.options.commandnotfound);this.writeln("\n")}this.current_command=this.command_history.length,this.lock_input()},Console.prototype._set_Text=function(e){return this.set_text(e.text,e.x,e.y)},Console.prototype.set_text=function(e,t,n){for(var a=0;a<e.length;a++){var i=e[a];if("\n"==i)n++,t=0;else if("	"==i)for(t+=this.options.tabcols;t%this.options.tabcols!=0;)t++;else this.buffer[this.memmap_addr+n*this.cols+t]=e[a],t++;n>=this.rows&&(this.scroll(1),n=this.rows-1),t>=this.cols&&(this.enable_external_input&&this.grab_extended&&this.last_col.push(t-1),t=0,n++)}return{x:t,y:n}},Console.prototype.scroll=function(e){this.memmap_addr+=this.cols*e,this.original_memmap_addr=this.memmap_addr,this.command_start_row--;for(var t=1;e>=t;t++)for(var n=0;n<this.cols;n++)this.buffer[this.memmap_addr+(this.rows-t)*this.cols+n]=" "},Console.prototype._writeln=function(e){this.writeln(e.text)},Console.prototype.writeln=function(e){this.write(e+"\n")},Console.prototype._write=function(e){this.write(e.text)},Console.prototype.write=function(e){var t=this.set_text(e,this.current_col,this.current_row);this.current_col=t.x,this.current_row=t.y},Console.prototype.draw_buffer=function(){var e,t=0,n=0,a=0,i=0;this.ctx.font="normal"+this.options.fontsize+"px "+this.options.fontname;var r=this.options.bkcolor,s=this.options.color;this.ctx.fillStyle=r,this.ctx.fillRect(0,0,this.width,this.height);var o=this.fontheight%2==0?this.fontheight:this.fontheight+1;this.ctx.textBaseline="middle";for(var l=0;l<this.rows;l++)for(var d=0;d<this.cols;d++)void 0!=(e=this.addr_format[this.memmap_addr+l*this.cols+d])&&(this.ctx.font="normal "+e.fontsize+"px "+e.fontname,r=e.bkcolor,s=e.color),t=d*this.fontwidth,a=t+this.fontwidth,n=l*o,i=n+o,this.ctx.fillStyle=r,this.ctx.fillRect(t,n+1,a-t,i-n-1),this.ctx.fillStyle=s,this.ctx.fillText(this.buffer[this.memmap_addr+l*this.cols+d],t,(i+n)/2,this.fontwidth)},Console.prototype.grab_input=function(e,t,n,a){this.enable_external_input=!0,this.input=!1,this.command=new Array,this.command_start_col=this.current_col,this.command_start_row=this.current_row,this.external_input_callback=e,this.grab_extended=n,this.grab_password=a,this.grab_required=t,this.last_col=new Array},Console.prototype.lock_input=function(){this.write(this.options.prompt+"# "),this.input=!0,this.command=new Array,this.command_start_col=this.current_col,this.command_start_row=this.current_row,this.enable_external_input=!1,this.grab_password=!1,this.last_col=null,this.external_input_callback=null},Console.prototype.unlock_input=function(){this.write("\n"),this.input=!1},Console.prototype.set_property=function(e){var t=new Array;for(i in this.options)e[i]?t[i]=e[i]:t[i]=this.options[i];this.addr_format[this.memmap_addr+this.current_row*this.cols+this.current_col]=t},Console.prototype.restore_properties=function(){this.addr_format[this.memmap_addr+this.current_row*this.cols+this.current_col]=this.options},jQuery.extend(Console,{CONSOLE_DEFAULTS:{bkcolor:"#000000",color:"#00FF00",fontname:"courier",fontsize:12,prompt:"root",tabcols:10,helpspaces:"	",helpcommand:"help",helpcommanddesc:"List all available commands.",clearcommand:"clear",clearcommanddesc:"Clear the console.",commandnotfound:"command not found. Type 'help' to the command list.",oninit:null}});