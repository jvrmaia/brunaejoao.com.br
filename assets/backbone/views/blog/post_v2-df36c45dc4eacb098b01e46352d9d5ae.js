var PostViewV2=null;!function(e){PostViewV2=BaseBackboneView.extend({events:{"click .comments-link":"toggleComments","click .close-comments":"toggleComments","click .write-comment":"writeComment","submit #comentario_form":"add_comment","click .ico-refresh":"changeCaptcha"},changeCaptcha:function(){this.options.captcha.fetch({data:{object:"comment"},success:function(){}})},drawCaptcha:function(){e("input[name='captcha_key']").val(this.options.captcha.get("key")),e(".captcha img").attr("src",this.options.captcha.get("image"))},writeComment:function(t){var o=e(t.currentTarget).attr("postid"),n=e("#write_window");this.$el.find(".write-window-area").prepend(n);var a=e("div[commentpostid='"+o+"']");n.find(".def-result-message").removeClass("error").removeClass("success").hide(),n.find("input[name='nome']").val(""),n.find("input[name='email']").val(""),n.find("input[name='comentario']").val(""),n.find("input[name='captcha']").val(""),n.find("*[data-field]").parent(".cnt").removeClass("error").find(".txt-error").hide(),n.attr("postid")==this.model.get("id_template_blog_post")?n.toggle():n.show(),a.is(":visible")&&n.is(":visible")&&a.hide(),n.find("#nome").focus(),n.attr("postid",this.model.get("id_template_blog_post")),n.find("#id_template_blog_post").val(this.model.get("id_template_blog_post")),this.delegateEvents(),this.changeCaptcha()},toggleComments:function(t){var o=e(t.currentTarget).attr("postid"),n=e("div[commentpostid='"+o+"']"),a=e("#write_window");n.toggle(),n.is(":visible")&&a.is(":visible")&&a.hide()},add_comment:function(){var t=this,o=this.options.noivos.get("id_noivo"),n=e("#comentario_form #id_template_blog_post").val(),a=e("#comentario_form #nome").val(),i=e("#comentario_form #email").val(),r=e("#comentario_form #comentario").val(),s=e("#comentario_form #captcha").val(),l=e("#comentario_form #captcha_key").val();e("*[data-field]").parent(".cnt").removeClass("error").find(".txt-error").hide();var c={nome:a,email:i,mensagem:r,captcha:s,captcha_key:l,id_noivo:o,id_template_blog_post:n},d=Validator.Assert,u=new Validator.Validator,p={nome:(new d).NotBlank(),email:(new d).Email(),mensagem:(new d).NotBlank(),captcha:(new d).NotBlank(),captcha_key:(new d).NotBlank(),id_noivo:(new d).NotNull(),id_template_blog_post:(new d).NotNull()},m=u.validate(c,p);if(1==m){var f=new TemplateBlogComentario;window.loading.jLoading("block",!0),f.save(c,{wait:!0,success:function(o,n,a){window.loading.jLoading("block",!1),e("#comentario_form #nome").val(""),e("#comentario_form #email").val(""),e("#comentario_form #comentario").val(""),e("#comentario_form #captcha").val(""),t.changeCaptcha();var i=I18n.t("blogs.comment_sent");if(0==f.get("status")&&(i+="<br/>"+I18n.t("blogs.comment_waiting")),e(".def-result-message").removeClass("error").addClass("success"),e(".def-result-message").html(i),e(".def-result-message").show(),0!=f.get("status")){var o=t.model;o.get("comentarios").push(f.attributes);var r=o.get("comentarios").length;t.$el.find(".comments-qtd").html(""+r);var s=render_template("template_blog_comment_id","/templates/backbone/"+t.options.noivos.get("id_noivo")+"/blog/"+t.options.noivos.get("template_html_version")+"/comment",{noivos:t.options.noivos.attributes,comentario:f.attributes});t.$el.find(".msgs-area").prepend(e(s))}var l=t.$el.find(".write-comment").position().top;e("html,body").animate({scrollTop:l},200),e("#cnt-comentario").text("4000 caracteres restantes")},error:function(o,n,a){window.loading.jLoading("block",!1);var i=n.responseText,r=JSON.parse(i);for(var s in r.errors){var l=r.errors[s];e("*[data-field='"+l.key+"']").parent(".cnt").addClass("error").find(".txt-error").html(l.value).show()}e(".def-result-message").addClass("error").removeClass("success"),e(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),e(".def-result-message").show();var c=t.$el.find(".write-comment").position().top;e("html,body").animate({scrollTop:c},200)}})}else{for(validation in m){var h=validation;"mensagem"==h&&(h="comentario"),e("*[data-field='"+h+"']").parent(".cnt").addClass("error").find(".txt-error").html(I18n.t("validatorjs."+m[validation][0].assert.__class__.toLowerCase())).show()}e(".def-result-message").addClass("error").removeClass("success"),e(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),e(".def-result-message").show(),e("html,body").animate({scrollTop:0},200)}},initialize:function(){this.constructor.__super__.initialize.call(this);var t=this;this.adopted=!0,this.options.captcha.on("change",this.drawCaptcha,this);var o=e("li[postid='"+this.model.get("id_template_blog_post")+"']");o.get(0)?this.setElement(o):(this.adopted=!1,render_template("template_blog_post_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/blog/"+this.options.noivos.get("template_html_version")+"/load_more",{noivos:this.options.noivos.attributes,post:this.options.model.attributes},function(e){t.setElement(e),t.options.onload&&t.options.onload.call(t)}))},render:function(){return this}})}(jQuery);