!function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(a,n){return t(a||e._,n||e.Backbone)}):t(_,Backbone)}(this,function(e,t){function a(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function n(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}return t.LocalStorage=window.Store=function(e){this.name=e;var t=null;t=window.contentStore?window.contentStore[this.name]:this.localStorage().getItem(this.name),t&&(t=JSON.parse(t)),this.records=t||[]},e.extend(t.LocalStorage.prototype,{save:function(){window.contentStore?window.contentStore[this.name]=JSON.stringify(this.records):this.localStorage().setItem(this.name,JSON.stringify(this.records))},create:function(e){return e.id||(e.id=n(),e.set(e.idAttribute,e.id)),this.records.push(e),window.contentStore?window.contentStore[this.name]=JSON.stringify(this.records):this.localStorage().setItem(this.name,JSON.stringify(this.records)),this.save(),this.find(e)},update:function(t){var a={};a[this.model.idAttribute]=this.model.id;var n=e.where(this.records,a);if(n){for(var i in t)n[i]=t[i];window.contentStore?window.contentStore[this.name]=JSON.stringify(this.records):this.localStorage().setItem(this.name,JSON.stringify(this.records))}else this.records.push(t),this.save();return this.find(t)},find:function(t){var a=null;if(a=window.contentStore?window.contentStore[this.name]:this.localStorage().getItem(this.name))try{a=JSON.parse(a)}catch(n){}var i=e.where(a,t);return 1==i.length&&(i=i[0]),i},findAll:function(){return this.records},destroy:function(t){return t.isNew()?!1:(this.save(),this.records=e.reject(this.records,function(e){return e===t.id.toString()}),this.save(),t)},localStorage:function(){return window.contentStore?{getItem:function(e){return window.contentStore[e]},setItem:function(e,t){window.contentStore[e]=t}}:localStorage?localStorage:{getItem:function(e){return""},setItem:function(e,t){}}},jsonData:function(e){return e&&JSON.parse(e)},_clear:function(){var t=this.localStorage(),a=new RegExp("^"+this.name+"-");t.removeItem(this.name),e.chain(t).keys().filter(function(e){return a.test(e)}).each(function(e){t.removeItem(e)})},_storageSize:function(){return this.localStorage().length}}),t.LocalStorage.sync=window.Store.sync=t.localSync=function(e,a,n){var i,r,s=a.localStorage||a.collection.localStorage,o=$.Deferred&&$.Deferred();try{var d=n.data||a.toJSON();switch(e){case"read":i=d?s.find(d):s.findAll();break;case"create":i=s.create(d);break;case"update":i=s.update(d);break;case"delete":i=s.destroy(d)}}catch(l){r=l.code===DOMException.QUOTA_EXCEEDED_ERR&&0===s._storageSize()?"Private browsing is unsupported":l.message}return i?(a.trigger("sync",a,i,n),n&&n.success&&("0.9.10"===t.VERSION?n.success(a,i,n):n.success(i)),o&&o.resolve(i)):(r=r?r:"Record Not Found",a.trigger("error",a,r,n),n&&n.error&&("0.9.10"===t.VERSION?n.error(a,r,n):n.error(r)),o&&o.reject(r)),n&&n.complete&&n.complete(JSON.stringify(i)),o&&o.promise()},t.ajaxSync=t.sync,t.getSyncMethod=function(e){return e.localStorage||e.collection&&e.collection.localStorage?t.localSync:t.ajaxSync},t.sync=function(e,a,n){return t.getSyncMethod(a).apply(this,[e,a,n])},t.LocalStorage});