var BlogView=null;!function(e){BlogView=BaseBackboneView.extend({events:{"click #close_write_window":"closeWriteWindow","click .ico-refresh":"changeCaptcha"},closeWriteWindow:function(){e("#write_window").hide()},changeCaptcha:function(){this.options.captcha.fetch({data:{object:"comment"},success:function(){}})},drawCaptcha:function(){e("input[name='captcha_key']").val(this.options.captcha.get("key")),e(".captcha img").attr("src",this.options.captcha.get("image"))},initialize:function(){this.constructor.__super__.initialize.call(this);var t=this;this.adopted=!0,this.posts_view=new Array,this.options.captcha.on("change",this.drawCaptcha,this);var o=e(".template-blog-"+this.options.entries.get("pagination").pag_atual);o.get(0)?(this.setElement(o),t.options.onload&&t.options.onload.call(t)):(this.adopted=!1,render_template("template_pagination_blog_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/pagination/default",{noivos:this.options.noivos.attributes,pages_info:this.options.entries.get("pagination")},function(e){render_template("template_blog_id","/templates/backbone/"+t.options.noivos.get("id_noivo")+"/blog/"+t.options.noivos.get("template_html_version")+"/index",{noivos:t.options.noivos.attributes,entries:t.options.entries.attributes,pages_html:e,pagina:t.options.pagina.attributes,captcha:t.options.captcha.attributes},function(e){t.setElement(e),t.options.onload&&t.options.onload.call(t)})}))},render:function(){var t=this;t.drawCaptcha();var o=this.options.entries.get("entries");for(i in o){var n=o[i],a=new TemplateBlogPost(n),r=new PostView({model:a});this.posts_view[a.get("id_template_blog_post")]=r}return load_css("//assets1.icasei.com.br/assets/formhelper.css"),load_js("//assets1.icasei.com.br/assets/formhelper.js",function(){e("#comentario").formhelper({defaultField:"nome",autoRender:!1,onSubmitError:function(){e("#write_window").find(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),e("#write_window").find(".def-result-message").addClass("error").removeClass("success"),e("#write_window").find(".def-result-message").show()},onSubmit:function(){var o=(this.getData(),t.options.noivos.get("id_noivo")),n=e("#comentario #id_template_blog_post").val(),a=e("#comentario #nome").val(),i=e("#comentario #email").val(),r=e("#comentario #comentario").val(),s=e("#comentario #captcha").val(),l=e("#comentario #captcha_key").val(),c=new TemplateBlogComentario;return window.loading.jLoading("block",!0),c.save({nome:a,email:i,message:r,captcha:s,captcha_key:l,id_noivo:o,id_template_blog_post:n},{wait:!0,success:function(o,n,a){window.loading.jLoading("block",!1),e("#comentario").formhelper("setvalue","nome",""),e("#comentario").formhelper("setvalue","email",""),e("#comentario").formhelper("setvalue","comentario",""),e("#comentario").formhelper("setvalue","captcha","");var i=I18n.t("blogs.comment_sent");if(0==c.get("status")&&(i+="<br/>"+I18n.t("blogs.comment_waiting")),e("#write_window").find(".def-result-message").removeClass("error").addClass("success"),e("#write_window").find(".def-result-message").html(i),e("#write_window").find(".def-result-message").show(),0!=c.get("status")){var r=t.posts_view[c.get("id_template_blog_post")],o=r.model;o.get("comentarios").push(c.attributes);var s=o.get("comentarios").length;r.$el.find(".comments_qtd").html(""+s);var l=render_template("template_blog_comment_id","/templates/backbone/"+t.options.noivos.get("id_noivo")+"/blog/comment",{noivos:t.options.noivos.attributes,comentario:c.attributes});r.$el.find(".def-comments").prepend(e(l))}},error:function(t,o,n){window.loading.jLoading("block",!1);var a=o.responseText,i=JSON.parse(a);for(var r in i.errors){var s=i.errors[r];e("#comentario").formhelper("flagerror",s.key,s.value)}e("#write_window").find(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),e("#write_window").find(".def-result-message").addClass("error").removeClass("success"),e("#write_window").find(".def-result-message").show()}}),!1}}),e("#comentario").formhelper("init")}),this}})}(jQuery);