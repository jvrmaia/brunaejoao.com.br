var MessagesViewV2=null;!function(e){MessagesViewV2=BaseBackboneView.extend({events:{"click .ico-refresh":"changeCaptcha","submit form":"sendMessage"},initialize:function(){this.constructor.__super__.initialize.call(this);var t=this;this.adopted=!0,this.options.captcha.on("change",this.drawCaptcha,this),this.options.messages.on("add",this.addMessage,this);var o=e(".template-messages");o.get(0)?(this.messages=[],this.setElement(o),this.options.onload&&this.options.onload.call(t)):(this.adopted=!1,render_template("template_message_id","/templates/backbone/"+this.options.noivos.get("id_noivo")+"/messages/"+this.options.noivos.get("template_html_version")+"/index",{noivos:this.options.noivos.attributes,messages:this.options.messages.toJSON(),pagina:this.options.pagina.attributes,captcha:this.options.captcha.attributes},function(e){t.messages=[],t.setElement(e),t.options.onload&&t.options.onload.call(t)}))},sendMessage:function(){var t=this,o=this.options.noivos.get("id_noivo"),n=e(".mensagens #nome").val(),a=e(".mensagens #email").val(),i=e(".mensagens #mensagem").val(),r=e(".mensagens #captcha").val(),s=e(".mensagens #captcha_key").val();this.$el.find(".txt-error").hide(),this.$el.find(".cnt.error").removeClass("error");var l=Validator.Assert,c=new Validator.Validator,d={nome:(new l).NotBlank(),email:(new l).Email(),mensagem:(new l).NotBlank(),captcha:(new l).NotBlank(),captcha_key:(new l).NotBlank(),id_noivo:(new l).NotNull()},u={nome:n,email:a,mensagem:i,captcha:r,captcha_key:s,id_noivo:o},p=c.validate(u,d);if(1==p){var m=new TemplateMsgNoivo;window.loading.jLoading("block",!0),m.save(u,{wait:!0,success:function(o,n,a){window.loading.jLoading("block",!1),t.options.messages.add(m),e(".mensagens #nome").val(""),e(".mensagens #email").val(""),e(".mensagens #mensagem").val(""),e(".mensagens #captcha").val(""),e("#cnt-mensagem").text("4000 caracteres restantes"),t.changeCaptcha()},error:function(t,o,n){window.loading.jLoading("block",!1);var a=o.responseText,i=JSON.parse(a);for(var r in i.errors){var s=i.errors[r];e("*[data-field='"+s.key+"']").parent(".cnt").addClass("error").find(".txt-error").html(s.value).show()}e(".def-result-message").addClass("error").removeClass("success"),e(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),e(".def-result-message").show(),e("html,body").animate({scrollTop:0},200)}})}else{for(validation in p)e("*[data-field='"+validation+"']").parent(".cnt").addClass("error").find(".txt-error").html(I18n.t("validatorjs."+p[validation][0].assert.__class__.toLowerCase())).show();e(".def-result-message").addClass("error").removeClass("success"),e(".def-result-message").html(I18n.t("formhelper.formhelper_invalid_values")),e(".def-result-message").show(),e("html,body").animate({scrollTop:0},200)}},addMessage:function(t,o,n){var a=this;new MessageViewV2({noivos:this.options.noivos,message:t,onload:function(){this.render(),this.adopted||0!=t.get("aprovada")&&(e(".no-message").remove(),e(".msgs > .row > ul").prepend(this.$el),this.$el.addClass("start_vertical_roll_animation")),a.messages[t.get("id_template_msg_noivos")]=this;var o=I18n.t("messages.message_sent");0==t.get("aprovada")&&(o+=" "+I18n.t("messages.message_waiting")),e(".def-result-message").html(o),e(".def-result-message").removeClass("error").addClass("success"),e(".def-result-message").show()}})},changeCaptcha:function(){this.options.captcha.fetch({data:{object:"message"},success:function(){}})},drawCaptcha:function(){e("input[name='captcha_key']").val(this.options.captcha.get("key")),e(".captcha img").attr("src",this.options.captcha.get("image"))},render:function(){e("#mensagem").ready(function(){e("#mensagem").keyup(function(){var t=this.value.length;4e3==t&&(this.value=this.value.substring(0,4e3)),e("#cnt-mensagem").text(4e3-t+" caracteres restantes")})});var t=this;return load_js("//assets1.icasei.com.br/assets/plugins/validator.js",function(){t.drawCaptcha(),t.options.messages.each(function(o){var n=new MessageViewV2({noivos:t.options.noivos,message:o});n.render(),n.adopted||e(".def-messages").prepend(n.$el),t.messages[o.get("id_template_msg_noivos")]=n})}),this}})}(jQuery);